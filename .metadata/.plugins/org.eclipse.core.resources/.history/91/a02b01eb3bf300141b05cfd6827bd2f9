package PTP;

import java.io.IOException;
import java.net.DatagramPacket;
import java.net.DatagramSocket;
import java.net.InetAddress;
import java.net.MulticastSocket;
import java.net.UnknownHostException;
import java.util.Random;

public class PTP implements Runnable
{
	private String ipMulticastAddress;
	private String ipDevice;
	private InetAddress group;
	private Type type;
	private int port;
	private int sessionID;
	
	public PTP (String ipMulticastAddress, Type type, int port, String ipDevice)
	{
		this.ipMulticastAddress = ipMulticastAddress;
		this.type = type;
		this.port = port;
		this.ipDevice = ipDevice;
		
		try 
		{
			group = InetAddress.getByName(ipMulticastAddress);
		} 
		catch (UnknownHostException e) 
		{
			// MUDAR ISTO AQUI
			e.printStackTrace();
		}
	}

	@Override
	public void run() 
	{
		if(type.equals(Type.SLAVE))
		{
	        byte[] buf = new byte[256];

	        try (MulticastSocket clientSocket = new MulticastSocket(port))
	        {
	            clientSocket.joinGroup(group);
	     
	            while (true) 
	            {
	                DatagramPacket msgPacket = new DatagramPacket(buf, buf.length);
	                clientSocket.receive(msgPacket);

	                String msg = new String(buf, 0, buf.length);
	                System.out.println("Socket 1 received msg: " + msg);
	            }
	        } 
	        catch (IOException ex) 
	        {
	            ex.printStackTrace();
	        }
		}
		
		sessionID = new Random().nextInt(9999);
		if(type.equals(Type.MASTER))
		{
		     
	        try (DatagramSocket serverSocket = new DatagramSocket()) 
	        {
	            for (int i = 0; i < 5; i++) 
	            {
	                byte[] msg = Protocols.Sync(ipDevice, sessionID, i);
	                DatagramPacket msgPacket = new DatagramPacket(msg,msg.length, group, port);
	                serverSocket.send(msgPacket);
	                
	                msg = Protocols.SendTimeSync(sessionID, i);
	                msgPacket = new DatagramPacket(msg,msg.length, group, port);
	                serverSocket.send(msgPacket);
	     
	                System.out.println("Server sent packet sync and timeSync with id " + i + " in session id "+sessionID);
	                Thread.sleep(500);
	            }
	        } 
	        catch (IOException ex) 
	        {
	            ex.printStackTrace();
	        } 
	        catch (InterruptedException e) 
	        {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}

		}
		
	}
	
	
}
